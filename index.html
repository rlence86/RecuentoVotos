<html>
<head>
<meta charset="utf-8" /> 
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/styles.css">
<script src="js/jquery-2.1.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/highcharts.js"></script>
<script src="js/printCharts.js"></script>
<script>
	function installationOk(){
		var dbfile = Ti.Filesystem.getFile(Ti.Filesystem.getApplicationDataDirectory(), 'recuento_votos.db');
		return dbfile.exists();
	}
	function showResults(){
		var db = Ti.Database.openFile(Ti.Filesystem.getFile(Ti.Filesystem.getApplicationDataDirectory(), 'recuento_votos.db'));
		var rows = db.execute("SELECT idPartido, sum(numero_votos) as votos FROM Resultado GROUP BY idPartido");
		var votos_validos = 0;
		var resultado_partidos = [];
		while (rows.isValidRow()) {
			votos_validos += parseInt(rows.fieldByName('votos'));
			resultado_partidos.push({"partido": rows.fieldByName('idPartido'), "votos": rows.fieldByName('votos')});
			rows.next();
		}
		var rows = db.execute("SELECT sum(blancos) as votos_blancos FROM Mesa");
		while (rows.isValidRow()) {
			votos_validos += parseInt(rows.fieldByName('votos_blancos'));
			rows.next();
		}
		var lista_partidos = [];
		var rows = db.execute("SELECT * from Partido");
		while (rows.isValidRow()) {
			lista_partidos.push({"id": rows.fieldByName('id'), "name": rows.fieldByName('siglas'), "color": rows.fieldByName('color'), "y": 0, "votos": 0});
			rows.next();
		}
		var resultados_electorales = calculo_dhont(resultado_partidos, votos_validos, 25, 5, lista_partidos);
		printChart(resultados_electorales);
	}
	function calculo_dhont(resultados, votos_validos, diputados, umbral, lista_partidos){
		var resultados_diputados = [];
		var minimo_votos = votos_validos * (umbral / 100);
		$.each(resultados,function(){
			if($(this)[0].votos < minimo_votos){
				$(this)[0].votos = 0;
			}
		});
		resultados.sort(function(a,b) { return parseFloat(b.votos) - parseFloat(a.votos) } );
		var indice_corte = 0
		$.each(resultados, function(){
			if($(this)[0].votos == 0){
				resultados = resultados.slice(0, indice_corte);
				return false;
			}
			indice_corte++;
		});
		var cocientes = [];
		$.each(resultados,function(){
			cocientes = getCocientes($(this)[0], diputados, cocientes);
		});
		cocientes.sort(function(a, b) {
		  if(parseInt(a.cociente) > parseInt(b.cociente)){
		  	return -1;
		  } else if (parseInt(a.cociente) < parseInt(b.cociente)){
		  	return 1;
		  } else if (parseInt(a.cociente) == parseInt(b.cociente)){
		  	if(parseInt(a.votos) > parseInt(b.votos)){
		  		return -1;
		  	} else if(parseInt(a.votos) < parseInt(b.votos)){
		  		return 1;
		  	} else {
		  		return -1;
		  	}
		  }
		});
		cocientes = cocientes.slice(0, diputados);
		resultados_diputados = getListaResultados(cocientes, lista_partidos);
		return resultados_diputados;
	}
	function getCocientes(resultados, diputados, cocientes){
		for(i = 1; i <= diputados; i++){
			cocientes.push({"cociente" : resultados.votos/i, "votos": resultados.votos, "partido": resultados.partido});
		}
		return cocientes;
	}
	function getListaResultados(cocientes, lista_partidos){
		$.each(cocientes,function(){
			var partido = $(this)[0].partido;
			var votos = $(this)[0].votos;
			$.each(lista_partidos, function(){
				if($(this)[0].id == partido){
					$(this)[0].y += 1;
					$(this)[0].votos = parseInt(votos);
				}
			});
		});
		lista_partidos.sort(function(a,b){
			if(a.y > b.y){
				return -1;
			} else if(a.y < b.y){
				return 1;
			} else if(a.votos > b.votos){
				return -1;
			} else {
				return 1;
			}
		});
		var indice_corte = 0;
		$.each(lista_partidos, function(){
			if($(this)[0].y == 0){
				lista_partidos = lista_partidos.slice(0, indice_corte);
				return false;
			}
			indice_corte++;
		});
		return lista_partidos;
	}
	$(document).ready(function(){
		$("header").load("header.html");
		if(installationOk()){
			$("#boton_setup").hide(false);
			showResults();
		} else {
			$("#grafica_superior").hide(false);
			$("#boton_add_resultado").hide(false);
			$("#boton_informes").hide(false);
		}
	});
</script>

</head>

<header>
	
</header>
	<div class="container">
		<div id="titulo">
		</div>
		<div id="grafica_superior">
		</div>
		<div id="botonera_accion" class="row">
			<div id="boton_add_resultado" class="col-xs-12">
				<a class="btn btn-primary" href="elegirmesa.html" style="width:100%;margin-bottom:20px;margin-top:20px;">AÃ±adir Resultado</a>
			</div>
			<div id="boton_informes" class="col-xs-12 col-sm-12">
				<a class="btn btn-primary" href="" style="width:100%;margin-bottom:20px;">Informes</a>
			</div>
			<div id="boton_setup" class="col-xs-12 col-sm-12">
				<a class="btn btn-primary" href="setup.html" style="width:100%;margin-bottom:20px;margin-top:200px">Setup</a>
			</div>
		</div>
	</div>
</body>
</html>