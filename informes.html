<html>
<head>
<meta charset="utf-8" /> 
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/styles.css">
<script src="js/jquery-2.1.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/highcharts.js"></script>
<script>
	$(document).ready(function(){
		$("header").load("header.html");
		var db = getDatabase();
		var chartdata = getChartData(db);
	});
	function getUrlParameter(sParam){
	    var sPageURL = window.location.search.substring(1);
	    var sURLVariables = sPageURL.split('&');
	    for (var i = 0; i < sURLVariables.length; i++) 
	    {
	        var sParameterName = sURLVariables[i].split('=');
	        if (sParameterName[0] == sParam) 
	        {
	            return sParameterName[1];
	        }
	    }
	    return false;
	}
	function getDatabase(){
		return Ti.Database.openFile(Ti.Filesystem.getFile(Ti.Filesystem.getApplicationDataDirectory(), 'recuento_votos.db'));
	}
	function getChartData(db){
		var distrito = getUrlParameter('distrito');
		var seccion = getUrlParameter('seccion');
		var mesa = getUrlParameter('mesa');
		var chartData = calcData(db, distrito, seccion, mesa);
	}
	function calcData(db, distrito, seccion, mesa){
		var query = "SELECT idPartido, sum(numero_votos) as votos FROM Resultado";
		query = completeQuery(query, distrito, seccion, mesa);		
		query +=  " GROUP BY idPartido";
		var resultado_partidos = [];
		var rows = db.execute(query);
		while (rows.isValidRow()) {
			votos_validos += parseInt(rows.fieldByName('votos'));
			resultado_partidos.push({"partido": rows.fieldByName('idPartido'), "votos": parseInt(rows.fieldByName('votos'))});
			rows.next();
		}
		var query_blancos = "SELECT sum(blancos) as votos_blancos, sum(nulos) as votos_nulos, sum(emitidos) as votos_emitidos FROM Mesa";
		query_blancos = completeQuery(query_blancos, distrito, seccion, mesa);
		var rows = db.execute(query_blancos);
		while (rows.isValidRow()) {
			rows.next();
		}
	}
	function completeQuery(query, distrito, seccion, mesa){
		if(distrito){
			query += " WHERE distritoID = '"+distrito+"'";
		} else {
			query += " WHERE 1";
		}
		if(seccion){
			query += " AND seccionId = '"+seccion+"'";
		} else {
			query += " AND 1";
		}
		if(mesa){
			query += " AND mesaId = '"+mesa+"'";
		} else {
			query += " AND 1";
		}
		return query;
	}
</script>
</head>

<header>
	
</header>
	<div class="container">
		<div>
			<a href="index.html"><h2>Volver</h2></a>
		</div>
		<div id="titulo">
		</div>
		<div id="grafica_superior">
		</div>
	</div>
</body>
</html>